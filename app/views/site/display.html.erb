<canvas id="canvas" width="900" height="500"></canvas>

<script>

  $(document).on('ready', function(){
    var width = $(window).width();
    var height = $(window).height();


    // initialize canvas

    var canvas = document.getElementById('canvas');
    canvas.width = width;
    canvas.height = height;

    var c = canvas.getContext("2d");

    var circleHeight = height / 2;
    var textHeight = height / 2 - 140;
    var lightWidth = width / 2 - 350;
    var temperatureWidth = width / 2;
    var soundWidth = width / 2 + 350;

    c.fillStyle = 'black';
    c.font="bold 30px Arial";

    var text = "Light";
    var textWidth = c.measureText(text).width;
    c.fillText("Light", lightWidth - textWidth/2, textHeight);

    text = "Temperature";
    textWidth = c.measureText(text).width;
    c.fillText("Temperature", temperatureWidth - textWidth/2, textHeight);
    
    text = "Sound";
    textWidth = c.measureText(text).width;
    c.fillText("Sound", soundWidth - textWidth/2, textHeight);

    c.fillStyle = '0010C2';
    c.beginPath();
    c.arc(lightWidth, circleHeight, 90, 0, Math.PI * 2, true);
    c.fill();

    c.beginPath();
    c.arc(temperatureWidth, circleHeight, 90, 0, Math.PI * 2, true);
    c.fill();

    c.beginPath();
    c.arc(soundWidth, circleHeight, 90, 0, Math.PI * 2, true);
    c.fill();


    // set AJAX calls for sensor inputs

    setInterval(function ajaxCall() {
      $.ajax({
        type: 'GET',
        url: '/input.json',
        async: true, // take out
        success: function(data){
          console.log("Light: " + data.light);
          console.log("Temperature: " + data.temperature);
          console.log("Sound: " + data.sound);
          updateLight(data.light);
          updateTemperature(data.temperature);
          updateSound(data.sound);
        },
        error: function(XMLHttpRequest, textStatus, errorThrown) { 
          console.log("Status: " + textStatus);
          console.log("Error: " + errorThrown); 
        }
      })
    }, 100);


    // initialize input history circular buffers

    createCircularBuffer("lightHistory", 30);
    createCircularBuffer("tempHistory", 30);
    createCircularBuffer("soundHistory", 30);


    // canvas update functions

    function updateLight(light) {
      updateBuffer(lightHistory, light);
      var blue = map(light, 400, 1000, 40, 100);
      c.fillStyle = 'rgb(0, 0, ' + blue +')';
      c.beginPath();
      c.arc(lightWidth, circleHeight, 90, 0, Math.PI * 2, true);
      c.fill();
    };

    function updateTemperature(temp) {
      updateBuffer(tempHistory, temp);
      var blue = map(light, 140, 155, 40, 100);
      c.fillStyle = 'rgb(0, 0, ' + blue +')';
      c.beginPath();
      c.arc(temperatureWidth, circleHeight, 90, 0, Math.PI * 2, true);
      c.fill();
    };

    function updateSound(sound) {
      updateSound(soundHistory, sound);
      updateBuffer(lightHistory, light);
      switch(true)
      {
      case (sound === 1):
        c.fillStyle = 'red';
        break;
      default:
        c.fillStyle = 'grey';
      }

      c.beginPath();
      c.arc(soundWidth, circleHeight, 90, 0, Math.PI * 2, true);
      c.fill();
    };


    // other function implementations

    function map(value, lower1, upper1, lower2, upper2) {
      var result;
      if ( lower1 == upper1 || lower2 == upper2 ) {
        return null;
      }
      else {
        var percentage = ( value - lower1 ) / ( upper1 - lower1 );
        var newValue = percentage * ( upper2 - lower2 ) + lower2;
        return Math.round(newValue);
      }
    };

    function createCircularBuffer(bufferName, bufferLength){ // string, number
      window[bufferName] = [];
      for ( var i = 0; i < bufferLength; i++ ) {
        window[bufferName].push(null);
      }
      window[bufferName].pointer = 0;
    }

    function updateBuffer(buffer, value){ // variable, number
      buffer[buffer.pointer] = value;
      if ( buffer.pointer < buffer.length - 1 ) {
        buffer.pointer ++;
      } else {
        buffer.pointer = 0;
      }
    }

    function getBufferHistory(buffer) { // variable
      var history = [];
      for ( var i = 0; i < buffer.length; i++ ) {
        if ( buffer[buffer.pointer] ) history.push(buffer[buffer.pointer]);
        if ( buffer.pointer < buffer.length - 1 ) {
          buffer.pointer ++;
        } else {
          buffer.pointer = 0;
        }
      }
      return history;
    }

  });

</script>